rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================================
    // 1. FUNCIONES DE INFRAESTRUCTURA (Lógica Booleana Pura)
    // =========================================================

    function isAuthenticated() {
      return request.auth != null && request.auth.token.isActive == true;
    }

    function hasRole(role) {
      return isAuthenticated() && 'roles' in request.auth.token && request.auth.token.roles.hasAny([role]);
    }

    function hasRoleAny(roles) {
      return isAuthenticated() && 'roles' in request.auth.token && roles.hasAny(request.auth.token.roles);
    }

    function isMaster() {
      return hasRole('master');
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isMember(residenciaId) {
        return isAuthenticated() && request.auth.token.residenciaId == residenciaId;
    }

    // Permite acceso si es Master, o si es miembro de la residencia y tiene uno de los roles.
    function isMemberWithRole(residenciaId, roles) {
      return isMember(residenciaId) && hasRoleAny(roles);
    }
    
    // =========================================================
    // 2. COLECCIONES RAÍZ (Globales)
    // =========================================================

    // --- RAÍZ COMERCIAL ---
    match /clientes/{clienteId} {
      allow read, write: if isMaster(); // Solo Master puede gestionar clientes
      
      match /facturas/{facturaId} {
        allow read, write: if isMaster();
      }
      match /pedidos/{pedidoId} {
        allow read, write: if isMaster();
      }
      match /contratosResidencia/{contratoId} {
        allow read, write: if isMaster();
      }
    }

    // --- RAÍZ OPERATIVA (SAAS) ---
    match /residencias/{residenciaId} {
      allow get:    if isMaster() || isMember(residenciaId);
      allow list:   if isMaster();
      allow create: if isMaster();
      allow update: if isMaster() || isMemberWithRole(residenciaId, ['admin']);
      allow delete: if isMaster();

      // --- SUBCOLECCIONES DE RESIDENCIA ---
      
      // Configuraciones (Singletons)
      match /configuracion/{docId} {
        allow get:    if isMaster() || (isMember(residenciaId) && resource.data.residenciaId == residenciaId);
        allow list:   if isMaster() || isMember(residenciaId);
        allow create, update: if isMaster() || (isMemberWithRole(residenciaId, ['admin']) && request.resource.data.residenciaId == residenciaId);
        allow delete: if isMaster() || (isMemberWithRole(residenciaId, ['admin']) && resource.data.residenciaId == residenciaId);
      }
      match /configContabilidad/{docId} {
        allow get:    if isMaster() || (isMemberWithRole(residenciaId, ['admin', 'contador']) && resource.data.residenciaId == residenciaId);
        allow list:   if isMaster() || isMemberWithRole(residenciaId, ['admin', 'contador']);
        allow create, update: if isMaster() || (isMemberWithRole(residenciaId, ['admin', 'contador']) && request.resource.data.residenciaId == residenciaId);
        allow delete: if isMaster() || (isMemberWithRole(residenciaId, ['admin', 'contador']) && resource.data.residenciaId == residenciaId);
      }

      // Colecciones operativas
      match /atenciones/{atencionId} {
        allow read:   if isMaster() || (isMemberWithRole(residenciaId, ['admin', 'director', 'asistente']) && resource.data.residenciaId == residenciaId);
        allow create, update: if isMaster() || (isMemberWithRole(residenciaId, ['admin', 'director', 'asistente']) && request.resource.data.residenciaId == residenciaId);
        allow delete: if isMaster() || (isMemberWithRole(residenciaId, ['admin', 'director', 'asistente']) && resource.data.residenciaId == residenciaId);
      }
      match /alteraciones/{alteracionId} {
        allow read:   if isMaster() || (isMemberWithRole(residenciaId, ['admin', 'director', 'asistente']) && resource.data.residenciaId == residenciaId);
        allow create, update: if isMaster() || (isMemberWithRole(residenciaId, ['admin', 'director', 'asistente']) && request.resource.data.residenciaId == residenciaId);
        allow delete: if isMaster() || (isMemberWithRole(residenciaId, ['admin', 'director', 'asistente']) && resource.data.residenciaId == residenciaId);
      }
      match /recordatorios/{recordatorioId} {
        allow read:   if isMaster() || (isMember(residenciaId) && resource.data.residenciaId == residenciaId);
        allow create, update:  if isMaster() || (isMemberWithRole(residenciaId, ['admin', 'director', 'asistente']) && request.resource.data.residenciaId == residenciaId);
        allow delete:  if isMaster() || (isMemberWithRole(residenciaId, ['admin', 'director', 'asistente']) && resource.data.residenciaId == residenciaId);
      }
       match /novedadesOperativas/{novedadId} {
        allow read:   if isMaster() || (isMemberWithRole(residenciaId, ['admin', 'director', 'asistente']) && resource.data.residenciaId == residenciaId);
        // Usuarios pueden crear/leer sus propias novedades operativas, director/asistente gestiona todos.
        allow create: if isMaster() || isMember(residenciaId) && request.resource.data.uid == request.auth.uid && request.resource.data.residenciaId == residenciaId;
        allow update: if isMaster() || isMember(residenciaId) && request.resource.data.uid == request.auth.uid && request.resource.data.residenciaId == residenciaId;
        allow delete: if isMaster();
      }

      // Actividades y sus inscripciones
      match /actividades/{actividadId} {
        allow read:   if isMaster() || (isMember(residenciaId) && resource.data.residenciaId == residenciaId);
        allow create, update:  if isMaster() || (isMemberWithRole(residenciaId, ['admin', 'director', 'asistente']) && request.resource.data.residenciaId == residenciaId);
        allow delete:  if isMaster() || (isMemberWithRole(residenciaId, ['admin', 'director', 'asistente']) && resource.data.residenciaId == residenciaId);

        match /inscripciones/{uid} {
           allow read:   if isMaster() || (isMember(residenciaId) && resource.data.residenciaId == residenciaId);
           // El propio usuario o roles de gestión pueden inscribir/desinscribir
           allow create, update:  if isMaster() || ((isOwner(uid) || isMemberWithRole(residenciaId, ['director', 'asistente'])) && request.resource.data.residenciaId == residenciaId);
           allow delete:  if isMaster() || ((isOwner(uid) || isMemberWithRole(residenciaId, ['director', 'asistente'])) && resource.data.residenciaId == residenciaId);
        }
      }

      // Solicitudes (Snapshot Inmutable)
      match /solicitudesConsolidadas/{solicitudId} {
        allow read:   if isMaster() || (isMemberWithRole(residenciaId, ['admin', 'director', 'asistente', 'contador']) && resource.data.residenciaId == residenciaId);
        allow write:  if false; // Solo se crean/modifican desde el backend (Cloud Functions)
        
        match /comensalesSolicitados/{comensalId} {
           allow read:   if isMaster() || (isMemberWithRole(residenciaId, ['admin', 'director', 'asistente', 'contador']) && resource.data.residenciaId == residenciaId);
           allow write:  if false;
        }
      }

      // Centros de Costo
      match /centrosDeCosto/{centroId} {
        allow read:   if isMaster() || isMemberWithRole(residenciaId, ['admin', 'director', 'contador', 'asistente']);
        allow write:  if isMaster() || isMemberWithRole(residenciaId, ['admin', 'contador']);
      }
    }

    // --- RAÍZ DE IDENTIDAD ---
    match /usuarios/{userId} {
      allow get:    if isMaster() || isOwner(userId) || hasRoleAny(['admin', 'director', 'asistente', 'contador']);
      allow list:   if isMaster() || hasRoleAny(['admin', 'director', 'asistente', 'contador']);
      allow create: if isMaster() || hasRole('admin');
      allow update: if isMaster() || isOwner(userId) || hasRole('admin');
      allow delete: if isMaster() || hasRole('admin');

      // --- SUBCOLECCIONES DE USUARIO ---
      // El usuario puede gestionar sus propios datos. Roles de gestión pueden leerlos.
      // Estas funciones definen QUIÉN puede acceder. La validación de integridad del dato (uid) se hace en la regla.
      function canReadSubcollection() {
        return isMaster() || isOwner(userId) || (isMember(request.auth.token.residenciaId) && hasRoleAny(['admin', 'director', 'asistente', 'contador']));
      }
      function canWriteSubcollection() {
        return isMaster() || isOwner(userId) || (isMember(request.auth.token.residenciaId) && hasRoleAny(['director', 'asistente']));
      }

      match /semanarios/{semanarioId} {
        allow read:   if canReadSubcollection() && resource.data.uid == userId;
        allow create, update:  if canWriteSubcollection() && request.resource.data.uid == userId;
        allow delete: if canWriteSubcollection() && resource.data.uid == userId;
      }
      match /excepciones/{excepcionId} {
        allow read:   if canReadSubcollection() && resource.data.uid == userId;
        allow create, update:  if canWriteSubcollection() && request.resource.data.uid == userId;
        allow delete: if canWriteSubcollection() && resource.data.uid == userId;
      }
      match /ausencias/{ausenciaId} {
        allow read:   if canReadSubcollection() && resource.data.uid == userId;
        allow create, update:  if canWriteSubcollection() && request.resource.data.uid == userId;
        allow delete: if canWriteSubcollection() && resource.data.uid == userId;
      }
      match /faltas/{faltaId} {
        allow read:   if (isMaster() || isOwner(userId) || (isMember(request.auth.token.residenciaId) && hasRoleAny(['admin', 'director', 'asistente']))) && resource.data.uid == userId;
        allow create, update: if (isMaster() || (isMember(request.auth.token.residenciaId) && hasRoleAny(['director', 'asistente']))) && request.resource.data.uid == userId;
        allow delete: if (isMaster() || (isMember(request.auth.token.residenciaId) && hasRoleAny(['director', 'asistente']))) && resource.data.uid == userId;
      }
    }

    // --- RAÍZ DE SISTEMA ---
    match /feedback/{feedbackId} {
      allow read:   if isMaster();
      allow list:   if isMaster();
      allow create: if isAuthenticated();
      allow update: if isMaster();
      allow delete: if isMaster();
    }
    match /logs/{logId} {
      allow read:   if isMaster();
      allow list:   if isMaster();
      allow create: if isAuthenticated(); // El backend escribe con identidad de usuario
      allow write:  if isMaster();
    }
  }
}
