rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Función para verificar si un usuario tiene un rol específico (ej: 'master', 'admin')
    function hasRole(role) {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.roles.hasAny([role]);
    }

    // Reglas para la colección de usuarios
    match /users/{userId} {
      // Un usuario solo puede leer o escribir su propio perfil.
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // Un 'master' puede leer cualquier perfil de usuario (útil para administración)
      allow get: if request.auth != null && hasRole('master');
    }

    // Reglas para la colección de residencias
    match /residencias/{residenciaId} {
      // Quién puede leer:
      // - Usuarios 'master'.
      // - Usuarios 'admin' si es su residencia asignada.
      allow get: if request.auth != null && (
                   hasRole('master') ||
                   (hasRole('admin') && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.residenciaId == residenciaId)
                 );
      // Los 'master' pueden listar (leer) todas las residencias
      allow list: if request.auth != null && hasRole('master');

      // Quién puede escribir (crear, actualizar, eliminar):
      // - Usuarios 'master' pueden hacer cualquier operación de escritura.
      allow create, delete: if request.auth != null && hasRole('master');
      // - 'Admin' solo puede actualizar su residencia asignada.
      allow update: if request.auth != null && (
                    hasRole('master') ||
                    (hasRole('admin') && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.residenciaId == residenciaId)
                  );
    }

    // Reglas para otras colecciones (ejemplo: dietas)
    // Es importante añadir reglas para cada colección que uses.
    match /dietas/{dietaId} {
        // Asumiendo que las dietas se leen y escriben en el contexto de una residencia
        // y que los permisos los heredan de la residencia
        allow read, write: if request.auth != null && (
                            hasRole('master') || hasRole('admin')
                           ); // Simplificado: master o admin pueden gestionar dietas. Ajustar si es necesario.
    }
  }
}